<script>
    // --- 1. Form Persistence Logic ---
    const fields = {
        vEmail: document.getElementById("vEmail"),
        vFirst: document.getElementById("vFirst"),
        vLast: document.getElementById("vLast"),
        vErr: document.getElementById("vErr"),
    };

    // Load saved values
    fields.vEmail.value = localStorage.getItem("chat_email") || "";
    fields.vFirst.value = localStorage.getItem("chat_first") || "";
    fields.vLast.value = localStorage.getItem("chat_last") || "";

    // Save on change
    ["input", "change"].forEach(evt => {
        fields.vEmail.addEventListener(evt, () => localStorage.setItem("chat_email", fields.vEmail.value.trim()));
        fields.vFirst.addEventListener(evt, () => localStorage.setItem("chat_first", fields.vFirst.value.trim()));
        fields.vLast.addEventListener(evt, () => localStorage.setItem("chat_last", fields.vLast.value.trim()));
    });

    // --- 2. Modal and Chat Launch Logic ---
    const liveBtn = document.getElementById("liveChatBtn");
    const modal = document.getElementById("askInfraModal");
    const yes = document.getElementById("askYes");
    const no = document.getElementById("askNo");

    liveBtn.addEventListener("click", () => modal.style.display = "block");
    no.addEventListener("click", () => window.location.href = "https://yaqs.corp.google.com/silicon/q/new?tag=infra");

    yes.addEventListener("click", function() {
        if (!fields.vEmail.value || !fields.vFirst.value || !fields.vLast.value) {
            fields.vErr.style.display = "block";
            return;
        }
        fields.vErr.style.display = "none";
        modal.style.display = "none";

        if (window.embeddedservice_bootstrap && embeddedservice_bootstrap.utilAPI) {
            embeddedservice_bootstrap.utilAPI.launchChat();
        }
    });

    // --- 3. Salesforce Initialization with Snippet Settings ---
    function initEmbeddedMessaging() {
        try {
            embeddedservice_bootstrap.settings.language = 'en_US';
            embeddedservice_bootstrap.settings.hideChatButtonOnLoad = true;

            // This specific structure is required for Enhanced Messaging
            embeddedservice_bootstrap.settings.snippetSettingsFile = {
                "prepopulatedPrechatFields": {
                    "_FirstName": localStorage.getItem("chat_email") ? localStorage.getItem("chat_first") : "",
                    "_LastName": localStorage.getItem("chat_email") ? localStorage.getItem("chat_last") : "",
                    "_Email": localStorage.getItem("chat_email") || ""
                }
            };

            embeddedservice_bootstrap.init(
                '00DDE0000044T2w',
                'New_Infra_Support',
                'https://silicon4--chattest3.sandbox.my.site.com/ESWNewInfraSupport1769449481682',
                { scrt2URL: 'https://silicon4--chattest3.sandbox.my.salesforce-scrt.com' }
            );
        } catch (err) {
            console.error('Error loading Embedded Messaging: ', err);
        }
    };
</script>
<script type='text/javascript' src='https://silicon4--chattest3.sandbox.my.site.com/ESWNewInfraSupport1769449481682/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>
