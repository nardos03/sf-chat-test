<!DOCTYPE html>
<html>
<head>
    <title>Salesforce Chat Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
</head>
<body>
    <h1>My Test Website</h1>
    <p>Testing my Salesforce Live Agent Chat...</p>
	
	<button id="liveChatBtn" type="button">Live Chat with Infra</button>

	<div id="askInfraModal" style="display:none; position:fixed; top:40%; left:40%; background:white; border:1px solid #333; padding:20px; z-index:9999;">
		<p>Have you tried Ask Infra?</p>
		<button id="askYes">Yes</button>
		<button id="askNo">No</button>
	</div>
	
<script type='text/javascript'>
	
    // 1. PLACE THE LISTENER FIRST (Before anything else)
    let isAgentAvailable = false;

    window.addEventListener("onEmbeddedMessagingAvailabilityCallback", (event) => {
        console.log("!!! SIGNAL RECEIVED FROM SALESFORCE:", event.detail.isAvailable);
        isAgentAvailable = event.detail.isAvailable;
    });

    // 2. Button Logic
    function setupButtonLogic() {
        const liveBtn = document.getElementById("liveChatBtn");
        const modal = document.getElementById("askInfraModal");
        const yes = document.getElementById("askYes");
        const no = document.getElementById("askNo");

        liveBtn.onclick = () => { modal.style.display = "block"; };
        no.onclick = () => { window.location.href = "https://yaqs.corp.google.com/silicon/q/new?tag=infra"; };

        yes.onclick = () => {
            modal.style.display = "none";
            console.log("Button clicked. Availability is currently:", isAgentAvailable);
           
            if (isAgentAvailable === true) {
                embeddedservice_bootstrap.utilAPI.launchChat();
            } else {
                alert("All support agents are currently unavailable or offline. Please try again later.");
            }
        };
    }

    // 3. Salesforce Init
    function initEmbeddedMessaging() {
        try {
            embeddedservice_bootstrap.settings.language = 'en_US';
            embeddedservice_bootstrap.settings.hideChatButtonOnLoad = true;

            embeddedservice_bootstrap.init(
                '00DDE0000044T2w',
                'New_Infra_Support',
                'https://silicon4--chattest3.sandbox.my.site.com/ESWNewInfraSupport1769449481682',
                {
                    scrt2URL: 'https://silicon4--chattest3.sandbox.my.salesforce-scrt.com'
                }
            );
            setupButtonLogic();
        } catch (err) {
            console.error('Error loading Embedded Messaging: ', err);
        }
    };
</script>

<script type='text/javascript' src='https://silicon4--chattest3.sandbox.my.site.com/ESWNewInfraSupport1769449481682/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>
	
    </body>
</html>
