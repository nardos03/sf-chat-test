<!DOCTYPE html>
<html>
<head>
  <title>Salesforce Chat Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
</head>
<body>

<h1>My Test Website</h1>
<p>Testing Salesforce Embedded Messaging</p>

<button id="liveChatBtn">Live Chat with Infra</button>

<div id="askInfraModal" style="display:none; position:fixed; top:40%; left:40%; background:white; border:1px solid #333; padding:20px; z-index:9999;">
  <p>Have you tried Ask Infra?</p>
  <button id="askYes">Yes</button>
  <button id="askNo">No</button>
</div>

<script>
/***********************
 * Modal logic
 ***********************/
const liveBtn = document.getElementById("liveChatBtn");
const modal = document.getElementById("askInfraModal");
const yes = document.getElementById("askYes");
const no = document.getElementById("askNo");

liveBtn.onclick = () => modal.style.display = "block";

no.onclick = () => {
  window.location.href = "https://yaqs.corp.google.com/silicon/q/new?tag=infra";
};

let isMessagingReady = false;

yes.onclick = () => {
  modal.style.display = "none";
  launchWhenReady();
};

function launchWhenReady() {
  if (!isMessagingReady || !window.embeddedservice_bootstrap?.utilAPI) {
    console.log("â³ Waiting for Embedded Messaging to load...");
    setTimeout(launchWhenReady, 500);
    return;
  }

  console.log("Launching chat");
  embeddedservice_bootstrap.utilAPI.launchChat();
}

/***********************
 * Helper: collect visitor context for hidden prechat fields
 ***********************/
async function getVisitorContext() {
  // Screen resolution
  const screenResolution = `${window.screen?.width || ""}x${window.screen?.height || ""}`;

  // Referrer (can be blank depending on browser/privacy/referrer policy)
  const referringSite = document.referrer || "";

  // Language
  const browserLanguage = navigator.language || navigator.userLanguage || "";

  // Platform
  const platform =
    (navigator.userAgentData && navigator.userAgentData.platform) ||
    navigator.platform ||
    "";

  // Network (not supported everywhere)
  const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  const network = conn
    ? [conn.effectiveType, conn.downlink ? `${conn.downlink}Mbps` : "", conn.rtt ? `${conn.rtt}ms` : ""]
        .filter(Boolean)
        .join(" | ")
    : "";

  // Browser name (basic UA parsing)
  const ua = navigator.userAgent || "";
  let browser = "Unknown";
  if (ua.includes("Edg/")) browser = "Edge";
  else if (ua.includes("OPR/") || ua.includes("Opera")) browser = "Opera";
  else if (ua.includes("Chrome/")) browser = "Chrome";
  else if (ua.includes("Safari/") && !ua.includes("Chrome/")) browser = "Safari";
  else if (ua.includes("Firefox/")) browser = "Firefox";

  // Visitor IP (requires external call)
  // NOTE: If this doesn't populate, you likely need to CSP-allowlist the domain in Salesforce.
  let visitorIpAddress = "";
  try {
    const ipRes = await fetch("https://api.ipify.org?format=json", { cache: "no-store" });
    const ipJson = await ipRes.json();
    visitorIpAddress = ipJson.ip || "";
  } catch (e) {
    console.warn("Could not fetch IP address:", e);
  }

  // Location options:
  // 1) GeoLocation (prompts user) - optional. Leaving blank by default.
  // 2) IP-based geolocation (requires a geo service) - optional.
  let location = "";

  // OPTIONAL: uncomment to attempt geolocation (will prompt user)
  /*
  try {
    location = await new Promise((resolve) => {
      if (!navigator.geolocation) return resolve("");
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve(`${pos.coords.latitude},${pos.coords.longitude}`),
        () => resolve(""),
        { enableHighAccuracy: false, timeout: 4000, maximumAge: 600000 }
      );
    });
  } catch (e) {
    // leave blank
  }
  */

  return {
    browser,
    browserLanguage,
    location,
    network,
    platform,
    referringSite,
    screenResolution,
    visitorIpAddress
  };
}

/***********************
 * Embedded Messaging Ready
 ***********************/
window.addEventListener("onEmbeddedMessagingReady", async () => {
  console.log("Embedded Messaging Ready");
  isMessagingReady = true;

  // Visible prechat fields (what the user sees)
  embeddedservice_bootstrap.prechatAPI.setVisiblePrechatFields({
    "_email": {
      value: "nardosa@google.com",
      isEditableByEndUser: true
    },
    "_firstName": {
      value: "Nardos",
      isEditableByEndUser: true
    },
    "_lastName": {
      value: "Assefa",
      isEditableByEndUser: true
    },
    "_subject": {
      value: "",
      isEditableByEndUser: true
    }
  });

  // Hidden prechat fields (your custom parameters / channel vars)
  try {
    const ctx = await getVisitorContext();

    // Keys MUST match your Channel Variable Names exactly (case + underscores)
    embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
      Browser: ctx.browser,
      Browser_Language: ctx.browserLanguage,
      Location: ctx.location,
      Network: ctx.network,
      Platform: ctx.platform,
      Referring_Site: ctx.referringSite,
      Screen_Resolution: ctx.screenResolution,
      Visitor_IP_Address: ctx.visitorIpAddress
    });

    console.log("Hidden prechat fields set:", ctx);
  } catch (err) {
    console.warn("Failed setting hidden prechat fields:", err);
  }
});

/***********************
 * Init Embedded Messaging
 ***********************/
function initEmbeddedMessaging() {
try {
embeddedservice_bootstrap.settings.language = 'en_US'; // For example, enter 'en' or 'en-US'

embeddedservice_bootstrap.init(
'00DDp0000015YvI',
'New_Infra_Support',
'https://silicon4.my.site.com/ESWNewInfraSupport1770290038401',
{
scrt2URL: 'https://silicon4.my.salesforce-scrt.com'
}
);
} catch (err) {
console.error('Error loading Embedded Messaging: ', err);
}
};
</script>

<script
  type="text/javascript"
  src="https://silicon4.my.site.com/ESWNewInfraSupport1770290038401/assets/js/bootstrap.min.js"
  onload="initEmbeddedMessaging()">
</script>

</body>
</html>

